<%# ai = @capability_statement.ai_output.present? ? JSON.parse(@capability_statement.ai_output) : {} %>
<% ai = if @capability_statement.ai_output.present?
           @capability_statement.ai_output.is_a?(String) ? JSON.parse(@capability_statement.ai_output) : @capability_statement.ai_output
         else
           {}
         end %>

<%= simple_form_for @capability_statement,
    url: @capability_statement.new_record? ? capability_statements_path : capability_statement_path(@capability_statement),
    html: { multipart: true } do |form| %>

    <% if @capability_statement.errors.any? %>
        <div class="error-summary">
            <h3><%= pluralize(@capability_statement.errors.count, "error") %> prevented this Capability Statement from saving:</h3>
            <ul>
            <% @capability_statement.errors.full_messages.each do |msg| %>
                <li><%= msg %></li>
            <% end %>
            </ul>
        </div>
    <% end %>

    <div class="form-sections">
        <div class="form-header">
            <%= image_tag "icon-bldg.svg", alt: "document icon", class:'form-section-icon' %>
            <h2>Company Info</h2>
        </div>
        <%= form.input :company_name, as: :string, input_html: {required: true} %>
        <div class="form-flex">
            <%= form.input :cage_code %>
            <%= form.input :uei %>
        </div>
        <%= form.input :company_logo, as: :file, label: "Upload Company Logo" %>
        <%= form.input :naics_codes, 
        as: :text,
        label: "NAICS Codes (comma separated)", 
        input_html: { value: @capability_statement.naics_codes&.join(", ") } %>
        <%= form.input :certifications,
        as: :select,
         collection: [
            "8(a)",
            "SDVOSB",
            "VOSB",
            "WOSB",
            "EDWOSB",
            "HUBZone",
            "DBE",
            "MBE",
            "SDB"
        ],
        label: "Certifications",
        input_html: { multiple: true, class: "custom-select" } %>
        <%= form.input :accepts_credit_cards, as: :boolean, label: "Accepts Credit Cards?", class:'checkbox' %>
    </div>

    <div class="form-sections">
        <div class="form-header">
            <%= image_tag "icon-bldg.svg", alt: "document icon", class:'form-section-icon' %>
            <h2>Capabilitites</h2>
        </div>
        <%if  @capability_statement.new_record? %>
            <%= form.input :introduction, as: :text, input_html: {required: true , rows: 3, placeholder: "e.g. Veteran-owned IT firm helping federal clients modernize systems." } %>
            <%= form.input :core_competencies, as: :text, input_html: {required: true, rows: 3, placeholder: "e.g. Cloud migration • Cybersecurity compliance • Custom software" } %>
            <%= form.input :differentiators, as: :text, input_html: {required: true, rows: 3, placeholder: "e.g. Veteran-owned small business • Section 508 compliance • Agile delivery" } %> 
            <%= form.input :past_performance, as: :text, input_html: {required: true, rows: 3, placeholder: "e.g. Delivered IT modernization for Dept. of Veterans Affairs, improving efficiency by 30%" } %>
        <% else %>
            <%= form.input :introduction, as: :text, input_html: {value: (ai["introduction"].is_a?(Array) ? ai["introduction"].join("\n") : ai["introduction"].to_s) , rows: 3, placeholder: "e.g. Delivered IT modernization for Dept. of Veterans Affairs, improving efficiency by 30%" } %>
            <%= form.input :core_competencies, as: :text, input_html: {required: true, value: (ai["core_competencies"].is_a?(Array) ? ai["core_competencies"].join("\n") : ai["core_competencies"].to_s), rows: 3, placeholder: "e.g. Veteran-owned small business • Section 508 compliance • Agile delivery" } %>
            <%= form.input :differentiators, as: :text, input_html: {required: true, value: (ai["differentiators"].is_a?(Array) ? ai["differentiators"].join("\n") : ai["differentiators"].to_s), rows: 3, placeholder: "e.g. Veteran-owned small business • Section 508 compliance • Agile delivery" } %> 
            <%= form.input :past_performance, as: :text, input_html: {value: (ai["past_performance"].is_a?(Array) ? ai["past_performance"].join("\n") : ai["past_performance"].to_s) , rows: 3, placeholder: "e.g. Delivered IT modernization for Dept. of Veterans Affairs, improving efficiency by 30%" } %>
        <% end %>
    </div>
    <div class="form-sections">
        <div class="form-header">
            <%= image_tag "icon-contact.svg", alt: "document icon", class:'form-section-icon' %>
            <h2>Contact Info</h2>
        </div>
        <%= form.simple_fields_for :company_contact do |contact| %>
            <%= contact.input :name %>
            <div class="form-flex">
                <%= contact.input :email %>
                <%= contact.input :phone %>
            </div>
            <%= contact.input :website %>
            <%= contact.input :street %>
            <div class="form-flex">
                <div class="form-address">
                    <%= contact.input :city %>
                </div>
                <div class="form-address-2">
                    <%= contact.input :state, 
                        as: :select, 
                        collection: [
                            "AL","AK","AZ","AR","CA","CO","CT","DE","FL","GA",
                            "HI","ID","IL","IN","IA","KS","KY","LA","ME","MD",
                            "MA","MI","MN","MS","MO","MT","NE","NV","NH","NJ",
                            "NM","NY","NC","ND","OH","OK","OR","PA","RI","SC",
                            "SD","TN","TX","UT","VT","VA","WA","WV","WI","WY"
                        ], 
                        include_blank: "Select a state", class: 'state' %>
                    <%= contact.input :postal_code %>
                </div>
            </div>
        <% end %>
    </div>
    <div class="form-action">
        <% count = current_generation_count %>
        <% ip_key = "ip:#{request.remote_ip}:generations" %>
        <% if @capability_statement.new_record? %>
            <% if count >= 3 %>
                <%= form.button :submit, "Free limit reached — try again tomorrow", class: "btn btn-primary" %>
            <% else %>
                <%= form.button :submit, "Generate Capability Statement", class: "btn btn-primary" %>
            <% end %>
            <% if count == 2 %>
                <p class="last-attempt-hint">
                ⚠️ This is your <strong>last free attempt</strong>. After this, payment is required.
                </p>
            <% end %>
        <% else %>
            <%= form.button :submit, "Update Capability Statement", class: "btn btn-primary" %>
        <% end %>

    </div>
<% end %>